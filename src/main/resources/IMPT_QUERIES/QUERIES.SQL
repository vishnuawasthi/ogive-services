
select * from  MEMBERSHIP_DETAILS  mbrship  ;
select *  FROM   MEMBER_DETAILS MBR ;
delete from MEMBERSHIP_DETAILS  where ID =23  ; 
select * from PAYMENT_DETAILS;


select mbrship.*,PYTM.TOTAL_PAID from (select mbrship.ID, mbrship.MEMBER_DETAILS_ID ,mbrship.joining_fee,mbrship.subscription_fee, mbrship.total_fee from  MEMBERSHIP_DETAILS  mbrship where  mbrship.ID =22 ) mbrship

LEFT JOIN 

(select pytm.MEMBER_ID, pytm.MEMBERSHIP_ID , SUM(AMOUNT) as TOTAL_PAID  from PAYMENT_DETAILS pytm WHERE  MEMBER_ID=18 AND MEMBERSHIP_ID =22 group by MEMBER_ID, MEMBERSHIP_ID ) PYTM

ON PYTM.MEMBERSHIP_ID = mbrship.ID;



/*  JOIN QUERY ********************************/

select * from (SELECT   
MBR.ID MEMBER_DETAILS_ID,
MBR.FIRST_NAME,
MBR.MIDDLE_NAME,
MBR.LAST_NAME,
MBR.DISPLAY_NAME,
MBRSHIP.ID MEMBERSHIP_DETAILS_ID,
MBRSHIP.JOINING_FEE,
MBRSHIP.SUBSCRIPTION_FEE,
MBRSHIP.DISCOUNT,
MBRSHIP.TOTAL_FEE,
MBRSHIP.DURATION,
MBRSHIP.START_DATE,
MBRSHIP.JOINING_DATE,
MBRSHIP.EXPIRE_DATE,
BUSINESS_UNIT_DTLS_ID FROM MEMBER_DETAILS   MBR  JOIN MEMBERSHIP_DETAILS MBRSHIP ON  MBR.ID = MBRSHIP.MEMBER_DETAILS_ID  AND  MBRSHIP.ID=? ) mbrship_dtls

left join 


/*    QUERY TO FIND PAYMENT DETAILS    */

SELECT MBRSHIP.*, PYTM.TOTAL_AMOUNT_PAID ,(COALESCE(TOTAL_FEE ,0)-  COALESCE(PYTM.TOTAL_AMOUNT_PAID,0))  DUE_AMOUNT    FROM (SELECT   
MBR.ID MEMBER_DETAILS_ID,   
MBR.FIRST_NAME,
MBR.MIDDLE_NAME,
MBR.LAST_NAME,
MBR.DISPLAY_NAME,
MBRSHIP.ID MEMBERSHIP_DETAILS_ID,
MBRSHIP.JOINING_FEE,
MBRSHIP.SUBSCRIPTION_FEE,
MBRSHIP.DISCOUNT,
MBRSHIP.TOTAL_FEE,
MBRSHIP.DURATION,
MBRSHIP.START_DATE,
MBRSHIP.JOINING_DATE,
MBRSHIP.EXPIRE_DATE,
BUSINESS_UNIT_DTLS_ID FROM MEMBER_DETAILS   MBR  JOIN MEMBERSHIP_DETAILS MBRSHIP ON  MBR.ID = MBRSHIP.MEMBER_DETAILS_ID    ) MBRSHIP  
LEFT JOIN 
(SELECT MEMBERSHIP_ID,SUM(AMOUNT) TOTAL_AMOUNT_PAID FROM PAYMENT_DETAILS  GROUP BY MEMBERSHIP_ID) PYTM ON  PYTM.MEMBERSHIP_ID=  MBRSHIP.MEMBERSHIP_DETAILS_ID;

/* ***********   QUERY FOR VIEW    ************************/

SELECT * FROM MEMBERSHIP_PAYMENT_DTLS;
DROP VIEW IF EXISTS MEMBERSHIP_PAYMENT_DTLS;

CREATE VIEW MEMBERSHIP_PAYMENT_DTLS_VIEW  AS SELECT MBRSHIP.*, PYTM.TOTAL_AMOUNT_PAID ,(COALESCE(TOTAL_FEE ,0)-  COALESCE(PYTM.TOTAL_AMOUNT_PAID,0))  DUE_AMOUNT    FROM (SELECT   
MBR.ID MEMBER_DETAILS_ID,   
MBRSHIP.ID MEMBERSHIP_DETAILS_ID,
MBR.FIRST_NAME,
MBR.MIDDLE_NAME,
MBR.LAST_NAME,
MBR.DISPLAY_NAME,
MBRSHIP.JOINING_FEE,
MBRSHIP.SUBSCRIPTION_FEE,
MBRSHIP.DISCOUNT,
MBRSHIP.TOTAL_FEE,
(MBRSHIP.TOTAL_FEE + personalTraining.total_fee)  TOTAL_TO_PAY,
MBRSHIP.DURATION,
MBRSHIP.START_DATE,
MBRSHIP.JOINING_DATE,
MBRSHIP.EXPIRE_DATE,
BUSINESS_UNIT_DTLS_ID FROM MEMBER_DETAILS   MBR  JOIN MEMBERSHIP_DETAILS MBRSHIP ON  MBR.ID = MBRSHIP.MEMBER_DETAILS_ID    LEFT JOIN personal_training_dtl personalTraining  ON  personalTraining.membership_details_id = MBRSHIP.MEMBERSHIP_DETAILS_ID  ) MBRSHIP  
LEFT JOIN 
(SELECT MEMBERSHIP_ID,SUM(AMOUNT) TOTAL_AMOUNT_PAID FROM PAYMENT_DETAILS  GROUP BY MEMBERSHIP_ID) PYTM ON  PYTM.MEMBERSHIP_ID=  MBRSHIP.MEMBERSHIP_DETAILS_ID;


/* UPDATE QUERY TO ACCOMODATE PERSONAL TRAINING CHANGES       It will not work for multiple memberships Or Trainings as it gives duplicates row if there are more than one.                         */

SELECT MBRSHIP.MEMBER_DETAILS_ID ,MBRSHIP.MEMBERSHIP_DETAILS_ID,  MBRSHIP.TOTAL_TO_PAY,PYTM.TOTAL_AMOUNT_PAID ,(MBRSHIP.TOTAL_TO_PAY -  COALESCE(PYTM.TOTAL_AMOUNT_PAID,0)) DUE_AMOUNT, MBRSHIP.FIRST_NAME,
MBRSHIP.MIDDLE_NAME,
MBRSHIP.LAST_NAME,
MBRSHIP.DISPLAY_NAME,
MBRSHIP.DURATION,
MBRSHIP.START_DATE,
MBRSHIP.JOINING_DATE,
MBRSHIP.EXPIRE_DATE
FROM (SELECT   
MBR.ID MEMBER_DETAILS_ID,   
MBRSHIP.ID MEMBERSHIP_DETAILS_ID,
MBR.FIRST_NAME,
MBR.MIDDLE_NAME,
MBR.LAST_NAME,
MBR.DISPLAY_NAME,
MBRSHIP.JOINING_FEE,
MBRSHIP.SUBSCRIPTION_FEE,
MBRSHIP.DISCOUNT,
MBRSHIP.TOTAL_FEE,
(COALESCE(MBRSHIP.TOTAL_FEE ,0) + COALESCE(PERSONALTRAINING.TOTAL_FEE,0))  TOTAL_TO_PAY,
MBRSHIP.DURATION,
MBRSHIP.START_DATE,
MBRSHIP.JOINING_DATE,
MBRSHIP.EXPIRE_DATE,
BUSINESS_UNIT_DTLS_ID FROM MEMBER_DETAILS   MBR  JOIN MEMBERSHIP_DETAILS MBRSHIP ON  MBR.ID = MBRSHIP.MEMBER_DETAILS_ID    LEFT JOIN PERSONAL_TRAINING_DTL PERSONALTRAINING  ON  PERSONALTRAINING.MEMBERSHIP_DETAILS_ID = MBRSHIP.ID  ) MBRSHIP  
LEFT JOIN 
(SELECT MEMBERSHIP_ID,SUM(AMOUNT) TOTAL_AMOUNT_PAID FROM PAYMENT_DETAILS  GROUP BY MEMBERSHIP_ID) PYTM ON  PYTM.MEMBERSHIP_ID=  MBRSHIP.MEMBERSHIP_DETAILS_ID;

/* ##########################################################  PERSONAL TRAINING VIEW  ############################################################## */


CREATE VIEW personal_training_view 
AS 
  SELECT MBR.id           AS MEMBER_ID, 
         PRSN.*, 
         STAFF.first_name AS TRAINER_FIRST_NAME, 
         STAFF.last_name  AS TRAINER_LAST_NAME 
  FROM   member_details MBR 
         JOIN membership_details MBRSHIP 
           ON MBRSHIP.member_details_id = MBR.id 
         JOIN personal_training_dtl PRSN 
           ON PRSN.membership_details_id = MBRSHIP.id 
         LEFT JOIN staff_details STAFF 
                ON STAFF.id = trainer_id; 




